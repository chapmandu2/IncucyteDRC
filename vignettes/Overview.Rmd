---
title: "Overview of the IncucyteDRC Package"
author: "Phil Chapman"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r message=FALSE, echo=FALSE, warnings=FALSE}
library(IncucyteDRC)
```

## Introduction


## Getting data in
Two convenience functions exist for importing platemap and data files into R.  The `importPlatemapXML` function imports .Platemap files generated by the Incucyte Zoom software to define the contents of a plate.  The function can extract the following parameters: Compound (description, concentration and units), Growth Condition (description), and CellType (description, passage and seeding density).  These are converted into a data frame format which is used as a basis for further analysis.  Alternatively, a data frame can be created in R but it must include the same column names as in the example below:

```{r}
test_pm <- importPlatemapXML(system.file(file='extdata/example.PlateMap', package='IncucyteDRC'))
head(test_pm)
```

The `importIncucyteData` function imports data from the data format generated by the Incucyte Zoom software.  To export data to the correct format <<<<<<DO THIS>>>>>>>.  You can also specify a metric (pc or percent confluence is the default) and a plateid.  The output is a `IncucyteDRCPlateData` S3 object which is a simple list object.

```{r}
test_data <- importIncucyteData(system.file(file='extdata/example_data.txt', package='IncucyteDRC'), metric='pc')
names(test_data)
head(test_data$data)
```

## The IncucyteDRCSet Object
The `IncucyteDRCSet` object is at the centre of the package workflow.  Subsequent functions add to and operate on the data contained within the object.

It can be initiated using the `makeIncucyteDRCSet` object and at its simplest just combines a plate map data frame generated by `importPlatemapXML` function with an `IncucyteDRCPlateData` object.  In addition, a cut time can be specified, and a single row metadata data frame.

A key attribute of an `IncucyteDRCSet` is that all of the data shares a common control growth curve.  Thus it is appropriate to have an `IncucyteDRCSet` object containing multiple compounds on a common cell line background, but if the cell line background changes then one object is needed per condition.

The `splitIncucyteDRCPlateData` function is a convenience function that splits up an `IncucyteDRCPlateData` object into a list of `IncucyteDRCSet` objects if necessary, or a single `IncucyteDRCSet` object if not.  It also automatically populates the metadata slot.  Therefore it is sensible to use this function, rather than the `makeIncucyteDRCSet` function, in a standard workflow.  An example of its use is below:

```{r}
test_list <- splitIncucyteDRCPlateData(test_pm, test_data, group_columns='growthcondition')
test_idrcset <- test_list[[2]]
class(test_list)
class(test_idrcset)
names(test_idrcset)
length(test_list)
for (t in test_list) print(t$metadata)
```

## Fitting growth curves
The first step in the analysis process is to fit growth curves to the data and visualise the output.  This is done using the related functions `fitGrowthCurvesGrouped` and `fitGrowthCurvesIndividual`.  The former will combine replicates to create a single growth curve for a given sample and concentration, whilst the latter will fit a growth curve for every single well on a plate.  The `IncucyteDRCSet` object is updated with four data frames containing the models themselves and the fitted data for plotting.  See the dplyr documentation for more on how models objects can be stored in data frames.

```{r}
test_idrcset <- fitGrowthCurvesGrouped(test_idrcset)
test_idrcset <- fitGrowthCurvesIndividual(test_idrcset)
names(test_idrcset)
```

Once the growth curves have been fitted, they can be visualised using the `plotIncucyteDRCSet` function:
```{r fig.width=6, fig.height=4}
plotIncucyteDRCSet(test_idrcset, grouped=FALSE)
plotIncucyteDRCSet(test_idrcset, grouped=TRUE)

```

## Definining a cut time for dose response analysis
Although the growth curves themselves can give some insight into the effect that different compounds have on the growth curve of the cell line, to analyse this formally we want to extract the growth parameter at a specific 'cut time'.  This can then form the basis of a dose response analysis to generate an EC50 value.  The cut time can be defined manually using the `calculateDRCData` and data exported using the `exportDRCDataToDataFrame` function: 

```{r fig.width=6, fig.height=4}
test_idrcset <- calculateDRCData(test_idrcset, cut_time = 200)
plotIncucyteDRCSet(test_idrcset, grouped=FALSE)
exportDRCDataToDataFrame(test_idrcset)
names(test_idrcset)

```

Note that the cut time is preserved in the `IncucyteDRCSet` object meaning that a subsequent call to the `plotIncucyteDRCSet` function can include this information as a blue dashed line.  Data can also be exported to a form suitable for PRISM:

```{r}
exportDRCDataToPRISM(test_idrcset)
```

Additional options allow for the inclusion of metadata in the output, and the inclusion of control data as zero concentration data points:

```{r}
exportDRCDataToDataFrame(test_idrcset, include_control = TRUE)
exportDRCDataToDataFrame(test_idrcset, add_metadata = TRUE)[1:5,]

```



